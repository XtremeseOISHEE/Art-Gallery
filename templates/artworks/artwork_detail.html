{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}{{ artwork.title }}{% endblock %}

{% block content %}
<h2>{{ artwork.title }}</h2>

<img src="{{ artwork.image.url }}" alt="{{ artwork.title }}" width="400px" height="600px">
<p>{{ artwork.description }}</p>
<p>Price: ${{ artwork.price }}</p>
<p>Category: {{ artwork.category }}</p>
<p>Artist: {{ artwork.artist.username }}</p>

{% if user == artwork.artist %}
    <a href="{% url 'artwork_edit' artwork.pk %}">Edit</a> |
    <a href="{% url 'artwork_delete' artwork.pk %}">Delete</a>
{% endif %}

{% if user.is_staff and not artwork.is_approved %}
    <form method="post" action="{% url 'artwork_approve' artwork.pk %}">
        {% csrf_token %}
        <button type="submit">Approve Artwork</button>
    </form>
{% endif %}

{% if show_order_button %}
    <form method="post" action="{% url 'create_order' artwork.pk %}">
        {% csrf_token %}
        <button type="submit">Order Now</button>
    </form>
{% endif %}

<hr>

<h3>Average Rating: {{ artwork.average_rating|default:"No ratings yet" }}‚≠ê</h3>
<p>Total Reviews: {{ reviews|length }} reviews</p>

<h3>Reviews:</h3>

{% for review in reviews %}
    <div class="review">
        <p><strong>{{ review.user.username }}</strong>: {{ review.rating }}‚≠ê - {{ review.comment }}</p>

        {% if review.is_verified_purchase %}
            <span>‚úÖ Verified Purchase</span>
        {% endif %}

        {% if user == review.user or user.is_staff %}
            <form method="post" action="{% url 'delete_review' review.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit">Delete Review</button>
            </form> |
            <a href="{% url 'edit_review' review.id %}">Edit</a>
        {% endif %}

        <p>üëç {{ review.likes_count }} | üëé {{ review.dislikes_count }}</p>

        <!-- Like/Dislike Buttons -->
        <a href="{% url 'like_review' review.id %}?like=1">Like</a> |
        <a href="{% url 'like_review' review.id %}?like=0">Dislike</a>

        <!-- Comments -->
        <h4>Comments:</h4>
        {% for comment in review.comments.all %}
            <div class="comment">
                <p>-- <strong>{{ comment.user.username }}</strong>: {{ comment.comment }}</p>

                {% if comment.user == user or user.is_staff %}
                    <a href="{% url 'edit_comment' comment.id %}">Edit</a> |
                    <form method="post" action="{% url 'delete_comment' comment.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" onclick="return confirm('Delete this comment?');">Delete</button>
                    </form>
                {% endif %}
            </div>
        {% empty %}
            <p>No comments yet.</p>
        {% endfor %}

        <p><a href="{% url 'add_comment' review.id %}">Add Comment</a></p>
    </div>
{% empty %}
    <p>No reviews yet.</p>
{% endfor %}

<hr>

{% if user.is_authenticated %}
    <h3>Leave a Review:</h3>
    <form method="post" action="{% url 'create_review' artwork.pk %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Submit Review</button>
    </form>
{% else %}
    <p><a href="{% url 'login' %}">Login</a> to post a review.</p>
{% endif %}

{% endblock %}
